name: app
type: php:8.2
disk: 1024

build:
  flavor: none

variables:
  env:
    APP_ENV: "prod"
    APP_DEBUG: "0"
    CORS_ALLOW_ORIGIN: "^https?://([^/]+\\.)?main-bvxea6i-rm5gtsnixyao4\\.fr-3\\.platformsh\\.site$"

web:
  locations:
    "/":
      root: "public"
      passthru: "/index.php"
      scripts: true
      allow: true

relationships:
  database: "db:mysql"
  mongodb: "mongodb:mongodb"

dependencies:
  php:
    composer/composer: "^2"

mounts:
  "/var": "shared:files"

hooks:
  build: |
    set -e
      # 1. Première installation: Installer toutes les dépendances SANS exécuter les scripts.
      # Ceci crée le répertoire 'vendor/'.
      composer install --no-dev --no-progress --prefer-dist --optimize-autoloader --no-scripts
      
      # 2. Injection: Injecter les variables d'environnement Platform.sh.
      # Le binaire 'platformsh-config' existe maintenant.
      php vendor/bin/platformsh-config inject-env --prefix=MONGODB_ --relation=mongodb
      
      # 3. Exécution des scripts: Exécuter les scripts automatiques de Symfony (y compris cache:clear).
      # Les scripts ont maintenant accès à MONGODB_URL.
      composer run-script --no-dev post-install-cmd

  deploy: |
    set -e
    php bin/console cache:clear --env=prod --no-debug
    php bin/console cache:warmup --env=prod
    rm -rf var/log/*

runtime:
  extensions:
    - gd
    - intl
    - pdo
    - pdo_mysql
    - opcache
    - mongodb
